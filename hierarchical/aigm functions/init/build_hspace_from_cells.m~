function [hmsh, hspace] = build_hspace_from_cells(dim, p, initial_num_el, cells,flag_whole_basis, graficar_malla)

if nargin == 5
    graficar_malla = 1;
end

[tp_msh, tp_space, geometry] = get_initial_msh_and_space(dim, p, initial_num_el);
[hmsh, hspace] = tp2hier (tp_msh, tp_space, geometry);

nref = numel(cells);

for ref = 1:nref
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% MARK
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    marked = cell(ref,1);
    marked(ref) = cells(ref);
    
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% REFINE MESH
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   
    [hmsh,new_cells] = refine_hierarchical_mesh(hmsh, marked, []);
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %% REFINE SPACE
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    hspace = refine_hierarchical_space(hmsh, hspace, marked,'elements',new_cells,flag_whole_basis);
    [hmsh, hspace] = refine (hmsh, hspace, marked, flag, flag_whole_basis);
end

if graficar_malla
plot_msh(hmsh)
end
